#!/bin/bash
# Git hook pour v√©rifier la compilation avant le push
# Emp√™che le push sur 'dev' si le projet ne compile pas

# ---------------------------------------------------------
# 1. V√©rification de la branche cible
# ---------------------------------------------------------

PROTECTED_BRANCH="refs/heads/dev" # La branche qu'on veut prot√©ger
SHOULD_CHECK=0

# Lecture des informations de push depuis l'entr√©e standard (stdin)
# Format: <local_ref> <local_sha> <remote_ref> <remote_sha>
while read local_ref local_sha remote_ref remote_sha
do
    if [[ "$remote_ref" == "$PROTECTED_BRANCH" ]]; then
        SHOULD_CHECK=1
    fi
done

if [ $SHOULD_CHECK -eq 0 ]; then
    echo "üïäÔ∏è  [PRE-PUSH] Branche non prot√©g√©e. Push autoris√© sans v√©rification."
    exit 0
fi

# ---------------------------------------------------------
# 2. Logique de compilation (Ex√©cut√©e seulement pour dev)
# ---------------------------------------------------------

echo "üõë [PRE-PUSH] Push vers 'dev' d√©tect√© !"
echo "üèóÔ∏è  [PRE-PUSH] D√©marrage de la v√©rification de compilation..."

# D√©finition d'un dossier de build temporaire
BUILD_DIR="build_check_pre_push"

# Nettoyage d'une √©ventuelle ex√©cution pr√©c√©dente interrompue
if [ -d "$BUILD_DIR" ]; then
    rm -rf "$BUILD_DIR"
fi

mkdir "$BUILD_DIR"
cd "$BUILD_DIR" || exit 1

# D√©tection du nombre de c≈ìurs
if [[ "$OSTYPE" == "darwin"* ]]; then
    CORES=$(sysctl -n hw.ncpu) # Mac
elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
    CORES=${NUMBER_OF_PROCESSORS:-1} # Windows
else
    CORES=$(nproc) # Linux
fi

echo "‚öôÔ∏è  [PRE-PUSH] Installation des d√©pendances Conan..."

LOG_FILE="../pre_push_build.log"

# Installation Conan
conan install .. --output-folder=. --build=missing -s build_type=Release > "$LOG_FILE" 2>&1

if [ $? -ne 0 ]; then
    echo "‚ùå [PRE-PUSH] √âchec de l'installation Conan !"
    echo "üìú Voir le log ci-dessous :"
    cat "$LOG_FILE"
    cd ..
    rm -rf "$BUILD_DIR"
    rm -f "$LOG_FILE"
    exit 1
fi

echo "‚öôÔ∏è  [PRE-PUSH] Configuration CMake..."

cmake .. -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-14 -DCMAKE_CXX_COMPILER=g++-14 >> "$LOG_FILE" 2>&1

if [ $? -ne 0 ]; then
    echo "‚ùå [PRE-PUSH] √âchec de la configuration CMake !"
    echo "üìú Voir le log ci-dessous :"
    cat "$LOG_FILE"
    cd ..
    rm -rf "$BUILD_DIR"
    rm -f "$LOG_FILE"
    exit 1
fi

echo "üî® [PRE-PUSH] Compilation du projet (Release)..."

cmake --build . -- -j"$CORES" >> "$LOG_FILE" 2>&1

if [ $? -ne 0 ]; then
    echo "‚ùå [PRE-PUSH] √âchec de la compilation !"
    echo "üìú Voir les erreurs ci-dessous :"
    tail -n 20 "$LOG_FILE"
    cd ..
    rm -rf "$BUILD_DIR"
    rm -f "$LOG_FILE"
    exit 1
fi

cd ..
rm -rf "$BUILD_DIR"
rm -f "$LOG_FILE"

echo "‚úÖ [PRE-PUSH] Compilation r√©ussie. Push vers 'dev' autoris√©."
exit 0