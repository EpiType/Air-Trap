#!/bin/bash
# Git hook pour v√©rifier la compilation avant le push
# Emp√™che le push si le projet ne compile pas

echo "üèóÔ∏è  [PRE-PUSH] D√©marrage de la v√©rification de compilation..."

# D√©finition d'un dossier de build temporaire pour ne pas toucher √† votre dossier de travail
BUILD_DIR="build_check_pre_push"

# Nettoyage d'une √©ventuelle ex√©cution pr√©c√©dente interrompue
if [ -d "$BUILD_DIR" ]; then
    rm -rf "$BUILD_DIR"
fi

mkdir "$BUILD_DIR"
cd "$BUILD_DIR" || exit 1

# D√©tection du nombre de c≈ìurs pour la compilation parall√®le
if [[ "$OSTYPE" == "darwin"* ]]; then
    CORES=$(sysctl -n hw.ncpu) # Mac
else
    CORES=$(nproc) # Linux
fi

echo "‚öôÔ∏è  [PRE-PUSH] Configuration CMake..."

# On redirige la sortie vers un log pour ne pas polluer le terminal sauf en cas d'erreur
LOG_FILE="../pre_push_build.log"

# Ex√©cution de CMake (On assume que Conan est d√©j√† g√©r√© ou que le CMake est autonome)
# Si vous utilisez Conan, d√©commentez la ligne suivante :
# conan install .. --build=missing -s build_type=Release > "$LOG_FILE" 2>&1 && \
cmake .. -DCMAKE_BUILD_TYPE=Release > "$LOG_FILE" 2>&1

if [ $? -ne 0 ]; then
    echo "‚ùå [PRE-PUSH] √âchec de la configuration CMake !"
    echo "üìú Voir le log ci-dessous :"
    cat "$LOG_FILE"
    cd ..
    rm -rf "$BUILD_DIR"
    rm -f "$LOG_FILE"
    exit 1
fi

echo "üî® [PRE-PUSH] Compilation du projet (Release)..."

cmake --build . -- -j"$CORES" >> "$LOG_FILE" 2>&1

if [ $? -ne 0 ]; then
    echo "‚ùå [PRE-PUSH] √âchec de la compilation !"
    echo "üìú Voir les erreurs ci-dessous :"
    # On affiche les 20 derni√®res lignes du log pour voir l'erreur
    tail -n 20 "$LOG_FILE"
    cd ..
    rm -rf "$BUILD_DIR"
    rm -f "$LOG_FILE"
    exit 1
fi

# Nettoyage
cd ..
rm -rf "$BUILD_DIR"
rm -f "$LOG_FILE"

echo "‚úÖ [PRE-PUSH] Compilation r√©ussie. Push autoris√©."
exit 0