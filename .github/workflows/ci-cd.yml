name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Code Style Check
  style-check:
    name: Code Style Check (clang-format & clang-tidy)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install clang-format and clang-tidy
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy

    - name: Check code formatting
      run: |
        find . -name "*.cpp" -o -name "*.hpp" | xargs clang-format --dry-run --Werror

    - name: Run clang-tidy
      run: |
        # Requires compile_commands.json - will be generated in build job
        echo "clang-tidy check (requires compilation database)"

  # Job 2: Build on Linux
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    needs: style-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libudev-dev libgl1-mesa-dev libx11-dev libxrandr-dev libfreetype6-dev libopenal-dev libflac-dev libvorbis-dev

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Conan
      run: |
        pip install conan
        conan profile detect

    - name: Cache Conan packages
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: conan-linux-${{ hashFiles('**/conanfile.txt') }}
        restore-keys: |
          conan-linux-

    - name: Install dependencies
      run: |
        mkdir -p build
        cd build
        conan install .. --build=missing -s build_type=Release

    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd build
        cmake --build . --config Release -j$(nproc)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: air-trap-linux
        path: |
          build/r-type_server
          build/r-type_client

  # Job 3: Build on Windows
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    needs: style-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Conan
      run: |
        pip install conan
        conan profile detect

    - name: Cache Conan packages
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: conan-windows-${{ hashFiles('**/conanfile.txt') }}
        restore-keys: |
          conan-windows-

    - name: Install dependencies
      run: |
        mkdir build
        cd build
        conan install .. --build=missing -s build_type=Release

    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd build
        cmake --build . --config Release

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: air-trap-windows
        path: |
          build/Release/r-type_server.exe
          build/Release/r-type_client.exe

  # Job 4: Build on macOS
  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    needs: style-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Conan
      run: |
        pip install conan
        conan profile detect

    - name: Cache Conan packages
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: conan-macos-${{ hashFiles('**/conanfile.txt') }}
        restore-keys: |
          conan-macos-

    - name: Install dependencies
      run: |
        mkdir -p build
        cd build
        conan install .. --build=missing -s build_type=Release

    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd build
        cmake --build . --config Release -j$(sysctl -n hw.ncpu)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: air-trap-macos
        path: |
          build/r-type_server
          build/r-type_client

  # Job 5: Unit Tests (Optional - requires test implementation)
  tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build-linux
    if: false  # Disabled until tests are implemented
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: air-trap-linux

    - name: Run tests
      run: |
        # Execute test binaries
        ./r-type_tests
