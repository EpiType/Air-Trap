name: CI/CD Pipeline

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main ]  # Only PRs to main (dev ‚Üí main)

env:
  MIRROR_URL: ${{ secrets.MIRROR_URL }}
  MIRROR_SSH_KEY: ${{ secrets.MIRROR_SSH_KEY }}
  DISCORD_WEBHOOK_MAINDEV: ${{ secrets.DISCORD_WEBHOOK_MAINDEV }}
  DISCORD_WEBHOOK_OTHER: ${{ secrets.DISCORD_WEBHOOK_OTHER }}

jobs:
  # Job 1: Commit Message Validation
  commit-validation:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    # Only run on main repository, not on mirrors
    if: github.event_name == 'push' && github.repository == 'EpiType/Air-Trap'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate commit messages
      run: |
        # Custom commit pattern: [TYPE] description
        # Types: ADD, FIX, CHORE, DOCS, STYLE, REFACTOR
        PATTERN="^\[(ADD|FIX|CHORE|DOCS|STYLE|REFACTOR)\] .+"
        
        # Get commits from push
        if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
          # New branch, check only the last commit
          COMMITS=$(git log -1 --pretty=format:"%H")
        else
          COMMITS=$(git log ${{ github.event.before }}..${{ github.sha }} --pretty=format:"%H")
        fi
        
        echo "üîç Validation des messages de commit..."
        INVALID=0
        
        for commit in $COMMITS; do
          MSG=$(git log -1 --pretty=format:"%s" $commit)
          
          # Ignorer les commits de merge
          if echo "$MSG" | grep -qE "^Merge "; then
            echo "‚è≠Ô∏è  SKIP (merge): $MSG"
            continue
          fi
          
          echo "Checking: $MSG"
          
          if ! echo "$MSG" | grep -qE "$PATTERN"; then
            echo "‚ùå INVALID: $MSG"
            echo ""
            echo "Le message doit suivre le format: [TYPE] description"
            echo "Types valides: [ADD], [FIX], [CHORE], [DOCS], [STYLE], [REFACTOR]"
            echo "Exemple: [ADD] player connection handler to server"
            INVALID=1
          else
            echo "‚úÖ VALID"
          fi
          echo ""
        done
        
        if [ $INVALID -eq 1 ]; then
          exit 1
        fi
        
        echo "‚úÖ Tous les commits sont valides!"

  # Job 2: Code Style Check
  style-check:
    name: Code Style Check (clang-format & clang-tidy)
    runs-on: ubuntu-latest
    needs: commit-validation
    # Only run on main repository, not on mirrors
    if: |
      github.repository == 'EpiType/Air-Trap' &&
      always() && 
      (needs.commit-validation.result == 'success' || needs.commit-validation.result == 'skipped')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install clang-format and clang-tidy
      run: |
        # Install clang-format-18 from Ubuntu repositories (has C++20, we'll use Latest for C++23)
        sudo apt-get update
        sudo apt-get install -y wget gnupg software-properties-common
        
        # Add LLVM official repository
        wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
        sudo add-apt-repository -y "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main"
        sudo apt-get update
        
        # Install clang-format-18 and clang-tidy-18
        sudo apt-get install -y clang-format-18 clang-tidy-18
        
        # Make them default
        sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-18 100
        sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-18 100
        
        clang-format --version

    # - name: Check code formatting
    #   run: |
    #     echo "üé® V√©rification du formatage du code..."
    #     FILES=$(find client server common -name "*.cpp" -o -name "*.hpp" 2>/dev/null || echo "")
        
    #     if [ -z "$FILES" ]; then
    #       echo "‚ö†Ô∏è Aucun fichier C++ trouv√©, skip"
    #       exit 0
    #     fi
        
    #     echo "$FILES" | xargs clang-format --dry-run --Werror

    - name: Run clang-tidy
      run: |
        echo "üîç Analyse statique avec clang-tidy..."
        
        # Check if compile_commands.json exists
        if [ ! -f "build/compile_commands.json" ]; then
          echo "‚ö†Ô∏è compile_commands.json non trouv√©, clang-tidy sera ex√©cut√© lors du build"
          exit 0
        fi
        
        FILES=$(find client server common -name "*.cpp" 2>/dev/null || echo "")
        
        if [ -z "$FILES" ]; then
          echo "‚ö†Ô∏è Aucun fichier C++ trouv√©"
          exit 0
        fi
        
        echo "$FILES" | xargs clang-tidy -p build

  # Job 3: Build on Linux
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    needs: style-check
    # Only run on main repository, not on mirrors
    if: github.repository == 'EpiType/Air-Trap'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libudev-dev libgl1-mesa-dev libx11-dev libxrandr-dev libfreetype6-dev libopenal-dev libflac-dev libvorbis-dev

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Conan
      run: |
        pip install conan
        conan profile detect

    - name: Cache Conan packages
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: conan-linux-${{ hashFiles('**/conanfile.txt') }}
        restore-keys: |
          conan-linux-

    - name: Install dependencies
      run: |
        mkdir -p build
        cd build
        conan install .. --build=missing -s build_type=Release

    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd build
        cmake --build . --config Release -j$(nproc)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: air-trap-linux
        path: |
          build/r-type_server
          build/r-type_client

  # Job 4: Build on Windows
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    needs: style-check
    # Only on PRs to main (dev ‚Üí main validation) and only on main repository
    if: |
      github.repository == 'EpiType/Air-Trap' &&
      github.event_name == 'pull_request' && 
      github.base_ref == 'main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Conan
      run: |
        pip install conan
        conan profile detect

    - name: Cache Conan packages
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: conan-windows-${{ hashFiles('**/conanfile.txt') }}
        restore-keys: |
          conan-windows-

    - name: Install dependencies
      run: |
        mkdir build
        cd build
        conan install .. --build=missing -s build_type=Release

    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd build
        cmake --build . --config Release

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: air-trap-windows
        path: |
          build/Release/r-type_server.exe
          build/Release/r-type_client.exe

  # Job 5: Build on macOS
  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    needs: style-check
    # Only on PRs to main (dev ‚Üí main validation) and only on main repository
    if: |
      github.repository == 'EpiType/Air-Trap' &&
      github.event_name == 'pull_request' && 
      github.base_ref == 'main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Conan
      run: |
        pip install conan
        conan profile detect

    - name: Cache Conan packages
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: conan-macos-${{ hashFiles('**/conanfile.txt') }}
        restore-keys: |
          conan-macos-

    - name: Install dependencies
      run: |
        mkdir -p build
        cd build
        conan install .. --build=missing -s build_type=Release

    - name: Configure CMake
      run: |
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd build
        cmake --build . --config Release -j$(sysctl -n hw.ncpu)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: air-trap-macos
        path: |
          build/r-type_server
          build/r-type_client

  # Job 6: Unit Tests (Optional - requires test implementation)
  tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build-linux
    if: false  # Disabled until tests are implemented
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: air-trap-linux

    - name: Run tests
      run: |
        # Execute test binaries
        ./r-type_tests

  # Job 7: Mirror Repository
  mirror:
    name: Mirror to External Repository
    runs-on: ubuntu-latest
    needs: [commit-validation, style-check, build-linux]
    # Mirror all branches after successful Linux build, only from main repository
    if: |
      github.repository == 'EpiType/Air-Trap' &&
      github.event_name == 'push' && 
      success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Setup SSH and Mirror repository
      id: mirror
      run: |
        set -e
        
        # Configuration SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.MIRROR_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H github.com >> ~/.ssh/known_hosts
        
        # Configuration Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global url."git@github.com:".insteadOf "https://github.com/"
        
        # Mirroring
        echo "üì° D√©marrage du mirror..."
        git remote add mirror "${{ secrets.MIRROR_URL }}"
        git fetch --all --tags
        
        echo "üöÄ Push vers le mirror..."
        git push mirror --all --force
        git push mirror --tags --force
        
        echo "‚úÖ Mirror termin√© avec succ√®s"

  # Job 8: Notification Discord
  notify:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    needs: [commit-validation, style-check, build-linux, build-windows, build-macos, mirror]
    # Only notify from main repository
    if: |
      github.repository == 'EpiType/Air-Trap' &&
      always() && 
      github.event_name == 'push'
    
    steps:
    - name: Send Discord notification
      run: |
        COMMIT_STATUS="${{ needs.commit-validation.result }}"
        STYLE_STATUS="${{ needs.style-check.result }}"
        LINUX_STATUS="${{ needs.build-linux.result }}"
        WINDOWS_STATUS="${{ needs.build-windows.result }}"
        MACOS_STATUS="${{ needs.build-macos.result }}"
        MIRROR_STATUS="${{ needs.mirror.result }}"
        
        BRANCH_NAME="${{ github.ref_name }}"
        COMMIT="$(echo "${{ github.sha }}" | head -c 7)"
        COMMITTER="${{ github.event.head_commit.author.name }}"
        MESSAGE="$(echo "${{ github.event.head_commit.message }}" | head -c 80)"
        
        # D√©terminer le webhook selon la branche
        if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "dev" ]; then
          WEBHOOK="${{ secrets.DISCORD_WEBHOOK_MAINDEV }}"
        else
          WEBHOOK="${{ secrets.DISCORD_WEBHOOK_OTHER }}"
        fi
        
        # Construire le message de statut
        if [ "$COMMIT_STATUS" = "failure" ]; then
          STATUS_MSG="‚ùå Commits invalides"
        elif [ "$STYLE_STATUS" = "failure" ]; then
          STATUS_MSG="‚ùå Style check √©chou√©"
        elif [ "$LINUX_STATUS" = "failure" ]; then
          STATUS_MSG="‚ùå Build Linux √©chou√©"
        elif [ "$WINDOWS_STATUS" = "failure" ] || [ "$MACOS_STATUS" = "failure" ]; then
          STATUS_MSG="‚ùå Build multi-plateforme √©chou√©"
        elif [ "$MIRROR_STATUS" = "failure" ]; then
          STATUS_MSG="‚ö†Ô∏è Build OK mais Mirror √©chou√©"
        elif [ "$MIRROR_STATUS" = "success" ]; then
          STATUS_MSG="‚úÖ Build + Mirror OK"
        else
          STATUS_MSG="‚úÖ Build OK"
        fi
        
        # Ajouter les d√©tails des builds
        BUILD_DETAILS=""
        if [ "$LINUX_STATUS" = "success" ]; then BUILD_DETAILS="${BUILD_DETAILS}üêß"; fi
        if [ "$WINDOWS_STATUS" = "success" ]; then BUILD_DETAILS="${BUILD_DETAILS}ü™ü"; fi
        if [ "$MACOS_STATUS" = "success" ]; then BUILD_DETAILS="${BUILD_DETAILS}üçé"; fi
        
        if [ -n "$BUILD_DETAILS" ]; then
          STATUS_MSG="$STATUS_MSG $BUILD_DETAILS"
        fi
        
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "{\"content\": \"**[$STATUS_MSG]**\nüåø Branch: \\\`$BRANCH_NAME\\\`\nüìù Commit: \\\`$COMMIT\\\` par **$COMMITTER**\nüí¨ Message: $MESSAGE\"}" \
             "$WEBHOOK"
